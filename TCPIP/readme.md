## TCP/IP
### 定义
* TCP/IP协议族是一组协议的集合，也叫互联网协议族，用来实现互联网上主机之间的相互通信。
### OSI七层模型
* 应用层、表示层、会话层、传输层、 网络层、数据链路层、物理层

### TCP/IP四层模型
* 应用层、传输层、 网络层、数据链路层

| OSI七层模型 | TCP/IP四层模型 |                功能                 |            TCP/IP协议族            |
| :---------: | :------------: | :--------------------------------: | :-------------------------------: |
|   应用层    |     应用层     | 文件传输、电子邮件、文件服务、虚拟终端 | TFTP、FTP、HTTP、SNMP、DNS、Telnet |
|   表示层    |     应用层     |     数据格式化、代码转换、数据加密     |                 无                 |
|   会话层    |     应用层     |       解除或建立别的结点的联系        |                 无                 |
|   传输层    |     传输层     |           提供端对端的接口           |              TCP、UDP              |
|   网络层    |     网络层     |           为数据包选择路由           |   IP、ICMP、RIP、OSPF、BGP、IGMP   |
|  数据链路层  |     链路层     |     传输有地址的帧及错误检测功能      |  SLIP、CSLIP、ARP、PPP、RARP、MTU  |
|   物理层    |     链路层     |    以2进制的形式在物理媒体传输数据     |    ISO2110、IEEE802、IEEE802.2     |

* TCP/IP协议族按照层次由上到下，层层包装。最上面的是应用层，这里面有http，ftp 等等我们熟悉的协议。而第二层则是传输层，著名的TCP和UDP协议就在这个层次。第三层是网络层，IP协议就在这里，它负责对数据加上IP地址和其他的数据以确定传输的目标。第四层是数据链路层，这个层次为待传送的数据加入一个以太网协议头，并进行CRC编码，为最后的数据传输做准备。
![数据封装.png](https://i.loli.net/2021/07/14/eL2QIR8WGc5Nfkg.png =500x)
* 上图清楚地表示了TCP/IP协议中每个层的作用，而TCP/IP协议通信的过程其实就对应着数据入栈与出栈的过程。入栈的过程，数据发送方每层不断地封装首部与尾部，添加一些传输的信息，确保能传输到目的地。出栈的过程，数据接收方每层不断地拆除首部与尾部，得到最终传输的数据。

#### 应用层
* TCP/IP的应用层对应于OSI的应用层、表示层、会话层。HTTP、FTP等协议在应用层。应用层在用户空间实现，负责处理特定的应用程序细节。

#### 传输层
* 传输层为两台主机提供端到端的通信，负责数据的收发、链路的超时重连。UDP/TCP协议在传输层。
##### TCP协议
![TCP首部.png](https://i.loli.net/2021/07/15/b4gvxNdJ6zFPZDs.png =500x)
1. 可靠的面向字节流的传输层协议。使用超时重传、数据确认等方式确保数据包被正确的发送到目的端。
2. TCP建立连接时需要三次握手。目的是同步连接双方的序列号和确认号并交换 TCP窗口大小信息。
    - 第一次握手：客户端发送请求报文段，将SYN位置为1随机产生一个值seq=J，并将该数据包发送到服务端，客户端进入**SYN_SENT**状态，等待服务端确认。
    - 第二次握手：服务端收到数据包，由SYN=1知道客户端请求建立连接，服务端将SYN、ACK[^ACK]置1，ack=j+1，随机产生seq=k并将该数据包发送到客户端以确认连接请求，服务端进入**SYN_RCVD**状态。
    - 第三次握手：客户端收到SYN+ACK报文段，确认ACK=1，ack=j+1如果正确则ACK置1，ack=k+1并将该数据包发送至服务端，服务端检查ACK=1、ack=k+1如果正确客户端和服务器端进入ESTABLISHED状态。
    ![三次握手.jpg](https://i.loli.net/2021/07/14/7jm5LtRApICxMoU.jpg =500x)
3. TCP终止连接时需要四次挥手。中断连接端可以是客户端也可以是服务端。
    - 第一次挥手：主机1发送FIN=m，用来关闭连接主机1进入FIN_WAIT_1状态。此状态含义为：如果如果主机2还存在未发送完的数据，则等待发送成功后再关闭，此时等待关闭。
    - 第二次挥手：主机2收到FIN=m后，向主机1发送ack=m+1，主机1进入FIN_WAIT_2状态，继续等待主机2的FIN报文。
    - 第三次挥手：当主机2确认没有数据时向主机1发送FIN=n，主机2进入LAST_ACK状态。
    - 第四次挥手：当主机1收到报文后，向主机2发送ACK报文，主机1进入TIME_WAIT状态。主机2收到主机1ACK报文就关闭连接。此时主机2等待2MSL[^MSL]后依然没有收到回复，证明连接正常关闭。
    ![四次挥手.jpg](https://i.loli.net/2021/07/14/QR3PBtx6IVAF1X8.jpg =500x)
4. TCP流量控制。如果发送方数据发送太快，接受方可能来不及接收，造成数据丢失。流量控制就是让发送方发送数据不致过快，要让接收方来得及接收。利用滑动窗口机制可以很方便地在TCP连接上实现对发送方的流量控制。
    - 滑动窗口：接收方每次接收到数据包，可以在发送报文确认时告诉对方自己的缓存区有多少是空闲的，缓存区剩余大小称之为窗口大小，用rwnd表示窗口大小。发送方收到之后会调整自己发送速率，当接收方窗口大小调整为0时发送方将停止发送数据，防止大量丢包情况出现。什么时候发送方可以继续发送数据？接收方rwnd=0（receiver window）时发送方停止发送报文，并同时开启一个定时器，每隔一段时间发送测试报文询问对方是否可以继续发送数据，如果可以接收方发送窗口大小，如果窗口大小依然为0，则发送方再次刷新启动定时器。
5. TCP拥塞控制。
    - 拥塞：在某段时间，若对网络中某一资源的需求超过了该资源所能提供的可用部分，网络性能就要变坏，这种情况就叫做网络拥塞。
    - 拥塞控制：防止过多的数据注入到网络中，这样可以使网络中的路由器或链路不致过载。拥塞控制所要做的都有一个前提：网络能够承受现有的网络负荷。拥塞控制是一个全局性的过程，涉及到所有的主机、路由器，以及与降低网络传输性能有关的所有因素。拥塞控制机制：**慢开始（慢启动）**、**拥塞避免**、**快重传**、**快恢复**
    - 慢开始：发送方维持一个拥塞窗口的状态变量，其值取决于网络的拥塞程度，并且动态变化。思路：先设置较小的窗口，探测网络的拥塞程度。从小到大逐渐增加拥塞窗口大小（上次的两倍）。为了防止拥塞窗口cwnd增长过大引起网络拥塞，还需要设置一个慢开始门限ssthresh状态变量。慢开始门限ssthresh的用法如下：
        * 当 cwnd < ssthresh 时，使用上述的慢开始算法。
        * 当 cwnd = ssthresh 时，可以使用慢开始也可以使用拥塞避免。
        * 当 cwnd > ssthresh 时，停止慢开始算法改用拥塞避免算法。
    - 拥塞避免：让拥塞窗口缓慢增大，即每经过一个往返时间RTT[^RTT]就把发送方的拥塞窗口+1，这样拥塞窗口按线性规律缓慢增长。**无论在慢开始阶段还是在拥塞避免阶段，只要出现网络拥塞就要把慢开始门限设置为出现拥塞时窗口值的一半。然后使cwnd=1执行慢开始算法。**
    ![拥塞算法1.jpg](https://i.loli.net/2021/07/14/k7w62RXpSHc8JEh.jpg =500x)
    - 快重传：快重传算法要求接收方每收到一个失序的报文段后就立即发出重复确认而不要等到自己发送数据时才进行捎带确认。发送方只要一连收到三个重复确认就应当立即重传对方尚未收到的报文段。
    - 快恢复：当发送方收到三个重复确认，就执行“乘法减小”算法，把慢开始门限ssthresh减半。把cwnd设置为慢开始门限ssthresh减半后的数值，然后执行拥塞避免算法，使拥塞窗口缓慢的线性增大。

##### UDP协议
* 不可靠、面向报文、无连接协议。
![UDP首部.png](https://i.loli.net/2021/07/15/hDdoGAxHCtqf5QB.png =500x)
1. 与TCP区别：
    - 无连接，时间上不存在建立连接需要的延迟。空间上，TCP需要在端系统中维护连接状态，需要一定的开销，装入包括收发缓存，拥塞控制参数及确认号的参数。UDP不维护连接状态，也不追踪这些参数，开销较小。
    - 分组首部开销小。TCP首部为20字节，UDP为8字节。
    - UDP没有拥塞控制。应用层能更好的控制要发送的数据和发送时间。
    - UDP提供最大努力交付，不保证可靠交付。所有维护可靠性工作需要在应用层完成。没有TCP的确认机制、重传机制。如果因为网络原因UDP数据没有到达接收方，UDP也不会给应用层返回错误信息。
    - UDP是面向报文的，对应用层交下来的报文，添加首部后直接交付IP层，既不拆分也不合并，保留这些报文的边界。报文是UDP数据报处理的最小单位。

#### 网络层
* 也叫IP层。网络层实现数据包的选路和转发。IP协议和路由器工作在网络层。
    1. IP协议：IP协议是TCP/IP协议的核心，所有的TCP，UDP，IMCP，IGMP的数据都以IP数据格式传输。IP协议是不可靠的协议，IP协议没有提供数据未达到的处理机制。
#### 数据链路层
* 也叫网络接口层。包括操作系统的设备驱动程序和网卡，它们一起处理与传输媒介（光纤等）的物理接口细节。

[^MSL]: 最大报文段生存时间
[^ACK]: 报文到达确认。ACK标志位
[^ack]: Acknowledgment Number ack数据
[^RTT]: Round Trip Time 一个连接的往返时间，即数据发送时刻到接收到确认的时刻的差值